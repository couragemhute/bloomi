{% extends 'layouts/base.html' %}
{% load static %}

{% block navigation %}
<!-- breadcumb-area start -->
<div class="breadcumb-area black-opacity bg-img-3">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <div class="breadcumb-wrap">
                    <h2>Our Products</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="breadcumb-menu">
        <div class="container">
            <div class="row">
                <div class="col-xs-12">
                    <ul>
                        <li><a href="{% url 'home' %}">Home</a></li>
                        <li>/</li>
                        <li>Products</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- breadcumb-area end -->
{% endblock %}

{% block content %}

<!-- products-area start -->
<div class="pricing-table-area ptb-100 bg-1">
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-md-offset-2 col-sm-10 col-sm-offset-1 col-xs-12">
                <div class="section-title text-center">
                    <h2>Products by Mistnex Dynamics</h2>
                    <p>We create intelligent digital solutions to help businesses grow. Currently available: our flagship WhatsApp Chatbot solution. More innovative products are coming soon.</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="pricing-table">
                <div class="pricing-grids active-price text-center">

                    <!-- WhatsApp Chatbot Product -->
                    <div class="col-md-4 col-sm-6 col-xs-12">
                        <div class="pricing-wrap">
                            <h3>WhatsApp Chatbot</h3>
                            <h4>Custom Quote</h4>
                            <ul>
                                <li>24/7 Customer Engagement</li>
                                <li>Automated Responses & Workflows</li>
                                <li>Order Processing & Support</li>
                                <li>WhatsApp Catalog Integration</li>
                            </ul>
                        </div>
                        <div class="mt-3">
                            <button id="onboard-btn" class="btn btn-primary">Get Started</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- products-area end -->

<!-- quote-area start -->
<div class="quote-area bg-1">
    <div class="container">
        <div class="row">
            <div class="col-sm-9 col-xs-12">
                <div class="quote-wrap">
                    <h2>Let Mistnex Dynamics help you automate, engage, and grow â€” starting with WhatsApp.</h2>
                </div>
            </div>
            <div class="col-sm-3 col-xs-12">
                <div class="quote-wrap text-right">
                    <button id="onboard-btn-quote" class="btn btn-primary">Request Onboarding</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- quote-area end -->

<!-- Facebook SDK for WhatsApp Embedded Signup -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId: "{{ FB_APP_ID }}",
      autoLogAppEvents: true,
      xfbml: true,
      version: "{{ FB_GRAPH_API_VERSION }}"
    });
  };

  // Listen for the embedded signup completion
  window.addEventListener('message', (event) => {
    if (!event.origin.endsWith('facebook.com')) return;
    try {
      const data = JSON.parse(event.data);
      if (data.type === 'WA_EMBEDDED_SIGNUP') {
        console.log('Embedded signup completed:', data);
        // Send the code to the backend to exchange for token
        fetch("{% url 'exchange_fb_code' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({
            code: data.code,
            business_id: data.business_id,
            business_name: data.business_name
          })
        })
        .then(res => res.json())
        .then(res => {
          if(res.access_token) {
              alert("Onboarding complete! Token generated.");
          } else if(res.error) {
              alert("Error: " + JSON.stringify(res.error));
          }
        })
        .catch(err => console.error("Error posting code:", err));
      }
    } catch(err) {
      console.log('Error parsing postMessage data:', event.data);
    }
  });

  // Launch WhatsApp Embedded Signup
  function launchWhatsAppSignup() {
    FB.login(function(response) {
      console.log("FB login response:", response);
    }, {
      config_id: "{{ FB_CONFIG_ID }}",
      response_type: 'code',
      override_default_response_type: true,
      extras: {
        setup: {},
        featureType: "{{ FB_FEATURE_TYPE }}",
        sessionInfoVersion: '3',
      }
    });
  }

  // Bind buttons
  document.getElementById("onboard-btn").onclick = launchWhatsAppSignup;
  document.getElementById("onboard-btn-quote").onclick = launchWhatsAppSignup;

</script>

{% endblock %}
