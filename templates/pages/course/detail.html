{% extends 'layouts/base.html' %}
{% load static %}

{% block navigation %}
<section id="about-home">
    <h2>About The BLOOMI Project</h2>
</section>
{% endblock %}

{% block content %}

<!-- Course Section -->
<section id="course-inner">
    <div class="overview">
        <img src="{{ course.image.url }}" class="course-img" alt="{{ course.title }}">
            <h2>{{course.title}} </h2>
       <div class="rating-stars d-flex align-items-center gap-2 rating_style">
    <div class="stars">
        {% for _ in ""|rjust:course.get_average_rating %}
            <span class="fa fa-star"></span>
        {% endfor %}
    </div>
    <p class="mb-0">({{ course.get_total_rating }} people rated)</p>
</div>


        <div class="course-head">
            <div class="c-name">
            
                <p>{{course.description}}</p>
            </div>
            <span>${{course.price}}</span>
        </div>

        <h3>Facilitator</h3>
        <div class="tutor">
            {% with assignment=course.current_expert %}
                {% if assignment.user.image %}
                    <img src="{{ assignment.user.image.url }}" alt="profile-user" class="rounded-circle me-2 thumb-sm" />
                {% else %}
                    <span class="text-muted">Not Uploaded</span>
                {% endif %}
            {% endwith %}
            <div class="tutor-det">
                <h5>      
                    {% with assignment=course.current_expert %}
                        {% if assignment %}
                            {{ assignment.user.full_name }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    {% endwith %}
                </h5>
                <p>{% with assignment=course.current_expert %}
                        {% if assignment %}
                            {{ assignment.user.facilitator_profession.name }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    {% endwith %}</p>
            </div>
        </div>

        <hr>
        <h3>Course Overview</h3>
        <p>{{course.overview}}</p>

        <hr>
        <h3>What You Will Learn</h3>
        <div class="learn">
            {% for item in course.learning_outcomes.all %}
                <p><i class="far fa-check-circle"></i> • {{ item.content }}</p>
            {% empty %}
                <li class="list-group-item text-muted">No learning outcomes added yet.</li>
            {% endfor %}
        </div>
    </div>

    <div class="enroll">
        <h3>What You Will Learn</h3>
        <div class="learn">
            <p><i class="far fa-video"></i> 52 hours video</p>
            <p><i class="far fa-newspaper"></i> 75 articles</p>
            <p><i class="far fa-cloud-download"></i> Downloadable resources</p>
            <p><i class="far fa-infinity"></i> Lifetime access</p>
            <p><i class="far fa-mobile-alt"></i> Access on mobile and TV</p>
            <p><i class="far fa-paperclip"></i> Assignments</p>
            <p><i class="far fa-trophy-alt"></i> Certificate of completion</p>
            {% comment %} <div class="enroll-btn">
                <a class="blue" href="#" onclick="openPaymentModal('Robotics', '80.00')">Enroll Now</a>
            </div> {% endcomment %}
            <!-- Enroll Button -->
<button class="cancel-btn btn-primary" onclick="openEnrollModal('{{ course.id }}')">
    Enroll Now
</button>


<!-- Custom Enroll Modal -->
<div id="enrollModal" class="rating-modal" style="display: none;">
    <div class="rating-modal-content">

        <h4 class="modal-title mb-3">Confirm Enrollment</h4>

        <p>
            Are you sure you want to enroll in
            <strong>{{ course.title }}</strong>?
        </p>

        <form method="post" action="{% url 'course_enroll_modal' course.pk %}">
            {% csrf_token %}
            <input type="hidden" name="course" id="modalEnrollCourseId" value="">

            <div class="modal-actions d-flex justify-content-end gap-2">
                <button type="button"
                        class="cancel-btn btn-secondary"
                        onclick="closeEnrollModal()">
                    Cancel
                </button>

                <button type="submit"
                        class="cancel-btn btn-primary">
                    Enroll
                </button>
            </div>
        </form>

    </div>
</div>

<!-- JS to control modal -->
<script>
function openEnrollModal(courseId) {
    document.getElementById("modalEnrollCourseId").value = courseId;
    document.getElementById("enrollModal").style.display = "block";
}

function closeEnrollModal() {
    document.getElementById("enrollModal").style.display = "none";
}
</script>


            
        </div>
        <!-- Course Ratings Card -->
<div class="course-ratings-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="course-rating-title text-center"><i class="bi bi-chat-dots-fill me-2"></i> Course Reviews</h4>
        <button class="cancel-btn btn-primary" onclick="openRatingModal('{{ course.id }}')">
            Rate this Course
        </button>
    </div>

    <div class="card-body course-ratings-body">
        {% for rating in course.course_ratings.all %}
        <div class="rating-entry">
            <div class="rating-header">
                <div class="rating-stars">
                    {% for _ in ""|rjust:rating.stars %}
                        <span class="fa fa-star"></span>
                    {% endfor %}
                    <span class="rating-user">{{ rating.user.full_name}}</span>
                </div>
                <small class="rating-time">{{ rating.created_at|timesince }} ago</small>
            </div>
            <p class="rating-comment">Comment: {{ rating.comment }}</p>
        </div>
        {% empty %}
        <p class="text-center text-muted">No reviews yet.</p>
        {% endfor %}
    </div>
</div>

<!-- Custom Rating Modal -->
<div id="courseRatingModal" class="rating-modal" style="display: none;">
    <div class="rating-modal-content">
        <h3 class="modal-title">Rate This Course</h3>

        <form method="post" action="{% url 'course-rating-create' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="course" id="modalCourseId" value="">

            <!-- Star Rating -->
            <div class="form-group">
                <label>Your Rating</label>
                <div class="star-selection">
                    {% for value, label in course_rating_form.stars.field.choices %}
                        <input type="radio" name="stars" value="{{ value }}"> {{ label }} ⭐
                    {% endfor %}
                </div>
            </div>

            <!-- Review Comment -->
            <div class="form-group">

     <div class="mb-3">
                                                <h5 class="text-body-highlight mb-3">Your Review</h5>
                                                {{course_rating_form.comment}}
                                              </div>            </div>

            <div class="modal-actions">
                <button type="button" class="cancel-btn btn-danger" onclick="closeRatingModal()">Cancel</button>
                <button type="submit" class="cancel-btn btn-primary">Submit</button>
            </div>
        </form>
    </div>
</div>


    </div>
</section>

<!-- Zimbabwe PayNow Payment Modal -->
<div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
        <span class="close-modal" onclick="closePaymentModal()">&times;</span>
        <h2>Enroll in Course</h2>
        <div class="course-summary">
            <h3 id="selectedCourse">Course Name</h3>
            <p class="course-price">Price: $<span id="coursePrice">0.00</span></p>
        </div>

        <div class="payment-options">
            <h3>Choose Zimbabwe Payment Method</h3>
            <div class="payment-methods">
                <div class="payment-method" onclick="selectPaymentMethod('ecocash')">
                    <i class="fas fa-mobile-alt"></i>
                    <span>EcoCash</span>
                </div>
                <div class="payment-method" onclick="selectPaymentMethod('onemoney')">
                    <i class="fas fa-wallet"></i>
                    <span>OneMoney</span>
                </div>
                <div class="payment-method" onclick="selectPaymentMethod('telecash')">
                    <i class="fas fa-phone"></i>
                    <span>Telecash</span>
                </div>
                <div class="payment-method" onclick="selectPaymentMethod('bank')">
                    <i class="fas fa-university"></i>
                    <span>Bank Transfer</span>
                </div>
                <div class="payment-method" onclick="selectPaymentMethod('paynow')">
                    <i class="fas fa-qrcode"></i>
                    <span>PayNow QR</span>
                </div>
                <div class="payment-method" onclick="selectPaymentMethod('card')">
                    <i class="fas fa-credit-card"></i>
                    <span>Credit Card</span>
                </div>
            </div>
        </div>

        <div id="paymentForm" class="payment-form" style="display: none;">
            <h3 id="paymentMethodTitle">Payment Details</h3>
            <div id="mobilePayment" style="display: none;">
                <p>Send <strong>$<span id="mobileAmount">0.00</span></strong> to:</p>
                <div class="payment-details">
                    <p><strong>Mobile Number:</strong> +263 78 123 4567</p>
                    <p><strong>Reference:</strong> BLOOMI-<span id="courseRef">COURSE</span></p>
                    <p><strong>Merchant:</strong> BLOOMI Project</p>
                </div>
                <div class="qr-code" id="qrCodeSection" style="display: none;">
                    <p>Or scan QR code:</p>
                    <div class="qr-placeholder">
                        <i class="fas fa-qrcode fa-3x"></i>
                        <p>QR Code would be generated here</p>
                    </div>
                </div>
            </div>

            <div id="bankPayment" style="display: none;">
                <p>Transfer <strong>$<span id="bankAmount">0.00</span></strong> to:</p>
                <div class="payment-details">
                    <p><strong>Bank:</strong> CBZ Bank</p>
                    <p><strong>Account Name:</strong> BLOOMI Project</p>
                    <p><strong>Account Number:</strong> 1234-5678-9012-3456</p>
                    <p><strong>Branch:</strong> Harare Main</p>
                    <p><strong>Reference:</strong> BLOOMI-<span id="bankCourseRef">COURSE</span></p>
                </div>
            </div>

            <div id="cardPayment" style="display: none;">
                <form id="cardPaymentForm">
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date</label>
                            <input type="text" id="expiryDate" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" placeholder="123" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cardName">Cardholder Name</label>
                        <input type="text" id="cardName" placeholder="John Doe" required>
                    </div>
                    <button type="submit" class="pay-now-btn">Pay Now - $<span id="finalPrice">0.00</span></button>
                </form>
            </div>
        </div>

        <div class="modal-actions">
            <button onclick="closePaymentModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}
