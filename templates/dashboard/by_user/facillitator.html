{% extends 'admin_layouts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3">

  <!-- ================= HEADER ================= -->
  <div class="mb-4">
    <h2 class="fw-bold">Facilitator Dashboard</h2>
    <p class="text-muted mb-0">
      Welcome back, {{ request.user.full_name }} ðŸ‘‹
    </p>
  </div>

  {% if facilitator %}

  <!-- ================= SUMMARY CARDS ================= -->
  <div class="row g-3 mb-4">

    <!-- Courses -->
    <div class="col-md-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between">
          <div>
            <p class="text-dark mb-1 fw-semibold">Courses Assigned</p>
            <h3 class="fw-bold mb-1">{{ facilitator.total_courses }}</h3>
            <small class="text-muted">Active courses</small>
          </div>
          <div class="d-flex align-items-center justify-content-center rounded-circle bg-light p-3">
            <i class="ti ti-book fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Students -->
    <div class="col-md-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between">
          <div>
            <p class="text-dark mb-1 fw-semibold">Total Students</p>
            <h3 class="fw-bold mb-1">{{ facilitator.total_students }}</h3>
            <small class="text-muted">Active enrollments</small>
          </div>
          <div class="d-flex align-items-center justify-content-center rounded-circle bg-light p-3">
            <i class="ti ti-users fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Rating -->
    <div class="col-md-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between">
          <div>
            <p class="text-dark mb-1 fw-semibold">Average Rating</p>
            <h3 class="fw-bold mb-1">{{ facilitator.average_rating }}</h3>
            <small class="text-muted">Across all courses</small>
          </div>
          <div class="d-flex align-items-center justify-content-center rounded-circle bg-light p-3">
            <i class="ti ti-star fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div class="col-md-6 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between">
          <div>
            <p class="text-dark mb-1 fw-semibold">Unread Messages</p>
            <h3 class="fw-bold mb-1">{{ facilitator.unread_messages }}</h3>
            <small class="text-muted">From students</small>
          </div>
          <div class="d-flex align-items-center justify-content-center rounded-circle bg-light p-3">
            <i class="ti ti-message fs-4"></i>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= CHARTS ================= -->
  <div class="row g-3 mb-4">

    <!-- Students per Course -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Students per Course</h5>
          <canvas id="studentsChart" height="140"></canvas>
        </div>
      </div>
    </div>

    <!-- Ratings per Course -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Average Ratings per Course</h5>
          <canvas id="ratingsChart" height="140"></canvas>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= COURSES TABLE ================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-semibold mb-3">My Courses</h5>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Course</th>
              <th>Level</th>
              <th>Students</th>
              <th>Rating</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for course in facilitator.facilitator_courses %}
            <tr>
              <td class="fw-semibold">{{ course.title }}</td>
              <td>{{ course.level|title }}</td>
              <td>{{ course.enrollments.count }}</td>
              <td>{{ course.get_average_rating|floatformat:1 }}</td>
              <td>
                <span class="badge bg-success">Active</span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                No courses assigned
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ================= CHAT ROOMS ================= -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="fw-semibold mb-3">Active Chat Rooms</h5>

      <ul class="list-group list-group-flush">
        {% for room in facilitator.chat_rooms %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ room.course.title }}</strong>
              <small class="text-muted">({{ room.room_type }})</small>
            </div>
            <span class="badge bg-primary rounded-pill">
              {{ room.participants.count }} members
            </span>
          </li>
        {% empty %}
          <li class="list-group-item text-muted text-center">
            No active chat rooms
          </li>
        {% endfor %}
      </ul>

    </div>
  </div>

  {% else %}
    <div class="alert alert-warning">
      You do not have facilitator access.
    </div>
  {% endif %}

</div>

<!-- ================= CHART JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  {% if facilitator %}

  // Students per course
  new Chart(document.getElementById('studentsChart'), {
    type: 'bar',
    data: {
      labels: {{ facilitator.charts.students_per_course.labels|safe }},
      datasets: [{
        label: 'Students',
        data: {{ facilitator.charts.students_per_course.data|safe }}
      }]
    }
  });

  // Ratings per course
  new Chart(document.getElementById('ratingsChart'), {
    type: 'line',
    data: {
      labels: {{ facilitator.charts.ratings_per_course.labels|safe }},
      datasets: [{
        label: 'Average Rating',
        data: {{ facilitator.charts.ratings_per_course.data|safe }}
      }]
    }
  });

  {% endif %}
</script>

{% endblock %}
