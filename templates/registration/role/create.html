{% extends 'admin_layouts/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block navigation %}
<!-- Page Navigation -->
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <nav aria-label="breadcrumb">
            <h4 class="page-title">Add Role</h4>
        </nav>
        <div>
            <button type="button" class="btn btn-outline-secondary ms-2" onclick="history.back();">
                &larr; Back
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-semibold">Name</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small">{{ form.name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <br>
                            <br>
                            <div class="form-check form-switch">
                                <input 
                                    type="checkbox" 
                                    class="form-check-input" 
                                    id="is_admin" 
                                    name="is_admin"
                                    {% if form.is_admin.value %}checked{% endif %}>
                                <label class="form-check-label fw-semibold" for="is_admin">Is Admin</label>
                            </div>
                            {% if form.is_admin.errors %}
                                <div class="text-danger small">{{ form.is_admin.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="permissionSearch">Permissions</label>
                        <input 
                            type="text" 
                            id="permissionSearch" 
                            class="form-control mb-3" 
                            placeholder="Search Permissions" 
                            onkeyup="filterPermissions()">
                        
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input 
                                                type="checkbox" 
                                                id="select_all_permissions" 
                                                onclick="toggleAllPermissions(this)">
                                        </th>
                                        <th>Permission Name</th>
                                    </tr>
                                </thead>
                                <tbody id="permissionsTable">
                                    {% for permission in form.permissions.field.queryset %}
                                    <tr>
                                        <td>
                                            <input 
                                                type="checkbox" 
                                                class="form-check-input" 
                                                id="permission_{{ permission.pk }}" 
                                                name="{{ form.permissions.html_name }}" 
                                                value="{{ permission.pk }}"
                                                {% if permission.pk in form.permissions.value %}checked{% endif %}>
                                        </td>
                                        <td>{{ permission.name }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if form.permissions.errors %}
                            <div class="text-danger small mt-1">{{ form.permissions.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-primary">Save Role</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleAllPermissions(source) {
        const checkboxes = document.querySelectorAll('input[name="{{ form.permissions.html_name }}"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
            toggleRowHighlight(checkbox);
        });
    }

    function toggleRowHighlight(checkbox) {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.classList.add('table-success');
        } else {
            row.classList.remove('table-success');
        }
    }

    function filterPermissions() {
        const searchInput = document.getElementById('permissionSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#permissionsTable tr');
        rows.forEach(row => {
            const permissionName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            row.style.display = permissionName.includes(searchInput) ? '' : 'none';
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll('input[name="{{ form.permissions.html_name }}"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => toggleRowHighlight(checkbox));
            toggleRowHighlight(checkbox); // highlight pre-checked
        });
    });
</script>
{% endblock %}
